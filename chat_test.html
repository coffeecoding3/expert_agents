<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAIA Chat Test</title>
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        /* ===== LAYOUT ===== */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            gap: 15px;
            height: calc(100vh - 20px);
            min-height: 600px;
        }

        .chat-container, .execution-log {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        /* ===== RESIZER ===== */
        .vertical-resizer {
            width: 6px;
            cursor: col-resize;
            background: rgba(102, 126, 234, 0.15);
            border-radius: 6px;
            align-self: stretch;
            flex: 0 0 6px;
            transition: background-color 0.2s;
        }

        .vertical-resizer:hover,
        .vertical-resizer.active {
            background: rgba(102, 126, 234, 0.35);
        }

        .main-container.resizing {
            user-select: none;
            cursor: col-resize;
        }

        .chat-container { 
            flex: 3; 
            min-width: 0;
        }
        .execution-log { 
            flex: 1; 
            display: flex;
            flex-direction: column;
            min-width: 300px;
        }
        
        /* ë¡œê·¸ê°€ ìˆ¨ê²¨ì¡Œì„ ë•Œ ì±„íŒ… ì»¨í…Œì´ë„ˆê°€ ì „ì²´ ë„ˆë¹„ë¥¼ ì°¨ì§€í•˜ë„ë¡ */
        .execution-log.collapsed {
            flex: 0;
            min-width: 0;
            width: auto;
            overflow: hidden;
        }
        
        .execution-log.collapsed .log-content {
            display: none;
        }
        
        /* ë¡œê·¸ê°€ ì ‘í˜”ì„ ë•Œ í—¤ë”ë§Œ ë³´ì´ë„ë¡ */
        .execution-log.collapsed .log-header {
            display: flex;
            min-width: 200px;
            width: auto;
        }
        
        .chat-container.full-width {
            flex: 1;
            width: 100%;
        }

        /* ===== HEADERS ===== */
        .chat-header, .log-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p, .log-header h3 {
            opacity: 0.9;
            font-size: 14px;
            margin: 0;
        }

        /* ===== CONFIG SECTION ===== */
        .config-section {
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .config-header:hover {
            background: #dee2e6;
        }

        .config-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }

        .config-toggle {
            font-size: 12px;
            color: #6c757d;
            transition: transform 0.2s;
        }

        .config-content {
            padding: 12px 20px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }

        .config-content.collapsed {
            max-height: 0;
            padding: 0 20px;
            opacity: 0;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-row:last-child { margin-bottom: 0; }

        .config-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            min-width: 80px;
        }

        .config-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
        }

        .tool-filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tool-filter-btn:hover {
            background: #f0f4ff;
            transform: translateY(-1px);
        }

        .tool-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* ===== CHAT MESSAGES ===== */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            min-height: 0;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user { justify-content: flex-end; }

        .message-content {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 15px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e1e5e9;
            border-bottom-left-radius: 4px;
        }

        .message.assistant .message-content.streaming {
            background: #f0f8ff;
            border-color: #667eea;
            animation: streaming-pulse 2s ease-in-out infinite;
        }

        /* ===== EVENT TYPE SPECIFIC STYLES ===== */
        .message.assistant .message-content.event-llm {
            background: #e8f5e8;
            border-color: #4caf50;
            border-left: 4px solid #4caf50;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.event-multi-llm {
            background: #f3e5f5;
            border-color: #9c27b0;
            border-left: 4px solid #9c27b0;
            margin-bottom: 8px;
        }


        .message.assistant .message-content.event-action-button {
            background: #fff9c4;
            border-color: #f57f17;
        }

        .message.assistant .message-content.event-user-search {
            background: #e1f5fe;
            border-color: #00bcd4;
        }

        .message.assistant .message-content.event-mail-to-event {
            background: #f1f8e9;
            border-color: #689f38;
        }

        .message.assistant .message-content.event-mail-todo-briefing {
            background: #fce4ec;
            border-color: #e91e63;
        }

        .message.assistant .message-content.event-mail-link {
            background: #e8eaf6;
            border-color: #3f51b5;
        }

        .message.assistant .message-content.event-event-link {
            background: #e0f2f1;
            border-color: #009688;
        }

        .message.assistant .message-content.event-person-in-charge-search {
            background: #fff8e1;
            border-color: #ffc107;
        }

        .message.assistant .message-content.event-documents {
            background: #f3e5f5;
            border-color: #9c27b0;
        }

        .message.assistant .message-content.event-question-suggest {
            background: #e8f5e9;
            border-color: #4caf50;
            padding: 12px 16px;
        }

        .question-suggest-item {
            background: white;
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            line-height: 1.5;
        }

        .question-suggest-item:hover {
            background: #f1f8e9;
            border-color: #689f38;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        .question-suggest-item:active {
            transform: translateX(2px);
        }

        .message.assistant .message-content.event-status {
            background: #fff3e0;
            border-color: #ff9800;
            border-left: 4px solid #ff9800;
            font-style: italic;
            color: #666;
        }

        .status-icon {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .message.assistant .message-content.event-error {
            background: #ffebee;
            border-color: #f44336;
        }

        /* ===== MARKDOWN STYLES ===== */
        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 12px 0 8px 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .message-content h1 { font-size: 1.5em; color: #333; }
        .message-content h2 { font-size: 1.3em; color: #444; }
        .message-content h3 { font-size: 1.2em; color: #555; }
        .message-content h4 { font-size: 1.1em; color: #666; }
        .message-content h5 { font-size: 1em; color: #777; }
        .message-content h6 { font-size: 0.9em; color: #888; }

        .message-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        .message-content pre {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            color: #333;
            border-radius: 0;
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
            line-height: 1.4;
        }

        .message-content blockquote {
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin: 8px 0;
            padding: 8px 16px;
            font-style: italic;
            color: #666;
        }

        .message-content hr {
            border: none;
            border-top: 2px solid #e1e5e9;
            margin: 16px 0;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 0.9em;
        }

        .message-content th, .message-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .message-content th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .message-content tr:nth-child(even) {
            background: #f8f9fa;
        }

        .message-content del {
            text-decoration: line-through;
            color: #999;
        }

        .message-content a {
            color: #667eea;
            text-decoration: underline;
        }

        .message-content a:hover {
            color: #5a6fd8;
        }


        /* ===== MULTI_LLM ROLE SPECIFIC STYLES ===== */
        .message.assistant .message-content.role-host {
            background: #e8f5e8;
            border-color: #4caf50;
            border-left: 4px solid #4caf50;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-crisis-expert {
            background: #ffebee;
            border-color: #f44336;
            border-left: 4px solid #f44336;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-global-marketing-expert {
            background: #e3f2fd;
            border-color: #2196f3;
            border-left: 4px solid #2196f3;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-product-expert {
            background: #f3e5f5;
            border-color: #9c27b0;
            border-left: 4px solid #9c27b0;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-cx-expert {
            background: #fff3e0;
            border-color: #ff9800;
            border-left: 4px solid #ff9800;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-trend-expert {
            background: #e0f2f1;
            border-color: #009688;
            border-left: 4px solid #009688;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-startup-expert {
            background: #f1f8e9;
            border-color: #689f38;
            border-left: 4px solid #689f38;
            margin-bottom: 8px;
        }

        .message.assistant .message-content.role-brand-expert {
            background: #fff9c4;
            border-color: #f57f17;
            border-left: 4px solid #f57f17;
            margin-bottom: 8px;
        }

        /* ===== INPUT SECTION ===== */
        .chat-input-container {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
            flex-shrink: 0;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus { border-color: #667eea; }

        .send-button, .test-button {
            padding: 14px 26px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .send-button:hover, .test-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-button {
            background: #4CAF50;
            padding: 8px 16px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* ===== STATUS & INDICATORS ===== */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-connecting {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }

        .typing-indicator.show { display: flex; }

        .typing-dots {
            display: inline-block;
            margin-left: 5px;
        }

        .typing-dots span {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #666;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        .typing-cursor {
            color: #667eea;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        /* ===== LOG SECTION ===== */
        .log-content {
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        .log-content::-webkit-scrollbar {
            width: 8px;
        }

        .log-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .log-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .log-content::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.processing { color: #007bff; }
        .log-entry.completed { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.streaming { color: #6f42c1; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.debug { color: #6c757d; }
        .log-entry.info { color: #17a2b8; }

        .log-timestamp {
            color: #6c757d;
            margin-right: 8px;
        }

        .toggle-log-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .toggle-log-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes streaming-pulse {
            0%, 100% { 
                background: #f0f8ff;
                border-color: #667eea;
            }
            50% { 
                background: #e6f3ff;
                border-color: #5a6fd8;
            }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header">
                <h1>ğŸ¤– CAIA Chat Test</h1>
                <p>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
                </p>
            </div>

            <div class="config-section">
                <div class="config-header" onclick="toggleConfig()">
                    <span class="config-title">âš™ï¸ ì„¤ì •</span>
                    <span class="config-toggle" id="configToggle">â–¼</span>
                </div>
                <div class="config-content" id="configContent">
                    <div class="config-row">
                        <span class="config-label">API URL:</span>
                        <!-- <input type="text" id="apiUrl" class="config-input" value="http://localhost:8888/caia/api/v1/chat/stream"> -->
                        <input type="text" id="apiUrl" class="config-input" value="https://dev.eaip.lge.com:30540/caia/api/v1/chat/stream">
                    </div>
                    <div class="config-row">
                        <span class="config-label">Session ID:</span>
                        <input type="text" id="sessionId" class="config-input" placeholder="ì„¸ì…˜ ID (ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±)" value="">
                        <small style="color: #6c757d; margin-left: 10px;">ê°™ì€ ì„¸ì…˜ì—ì„œ ëŒ€í™” ì—°ì†ì„± ìœ ì§€</small>
                    </div>
                    <div class="config-row">
                        <span class="config-label">SSO Cookie:</span>
                        <input type="text" id="cookieValue" class="config-input" placeholder="ssolgenet_exa ê°’ ì…ë ¥..." value="id%3DbUINZLKeUBfxlfJwCEzM845l495BUO70GnNR3XQoYR4yMDI1MDkyODIzNTQxNQ%3D%3D">
                    </div>
                    <div class="config-row">
                        <span class="config-label">User ID:</span>
                        <input type="text" id="userId" class="config-input" value="" readonly style="background-color: #f8f9fa; color: #6c757d;">
                        <small style="color: #6c757d; margin-left: 10px;">SSO ë¡œê·¸ì¸ì—ì„œ ìë™ ì¶”ì¶œ</small>
                    </div>
                    <div class="config-row">
                        <span class="config-label">ë„êµ¬ í•„í„°:</span>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;">
                            <button type="button" class="tool-filter-btn" data-tool="gemini_web_search" id="tool-gemini_web_search">
                                ğŸ” ì›¹ê²€ìƒ‰
                            </button>
                            <button type="button" class="tool-filter-btn" data-tool="llm_knowledge" id="tool-llm_knowledge">
                                ğŸ“š ê¸°ë³¸ì§€ì‹
                            </button>
                            <button type="button" class="tool-filter-btn" data-tool="internal_knowledge" id="tool-internal_knowledge">
                                ğŸ¢ ì‚¬ë‚´ì§€ì‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-content">
                        ë‹¹ì‹ ì„ ìœ„í•œ í† ë¡  ì—ì´ì „íŠ¸ CAIAì…ë‹ˆë‹¤. ğŸ‰<br>
                        ì§ˆë¬¸ì„ ì…ë ¥í•´ë³´ì„¸ìš”!
                    </div>
                </div>
            </div>
            
        <div class="typing-indicator" id="typingIndicator">
            <span id="typingText">CAIAê°€ ìƒê° ì¤‘ ì…ë‹ˆë‹¤<div class=""></div></span>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm">
                    <input type="text" id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                    <button type="submit" class="send-button" id="sendButton">ì „ì†¡</button>
                </form>
                <div class="test-buttons" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="newSession()" class="test-button" style="background: #17a2b8;">ğŸ†” ìƒˆ ëŒ€í™”</button>
                    <button onclick="toggleLog()" class="test-button" style="background: #6c757d;">ğŸ“‹ ë¡œê·¸</button>
                    <button onclick="testUserSearch()" class="test-button" style="display: none;">ğŸ‘¤ ì‚¬ìš©ì ê²€ìƒ‰</button>
                    <button onclick="testDocuments()" class="test-button" style="display: none;">ğŸ“š ë¬¸ì„œ ê²€ìƒ‰</button>
                    <button onclick="testActionButton()" class="test-button" style="display: none;">ğŸ”˜ ì•¡ì…˜ ë²„íŠ¼</button>
                    <button onclick="testMailToEvent()" class="test-button" style="display: none;">ğŸ“§ ì´ë©”ì¼â†’ì¼ì •</button>
                </div>
            </div>
        </div>
        <div class="vertical-resizer" id="verticalResizer" aria-label="Resize panels" title="ë“œë˜ê·¸í•˜ì—¬ í¬ê¸° ì¡°ì ˆ"></div>
        <!-- Execution Log -->
        <div class="execution-log">
            <div class="log-header">
                <h3>ğŸ” ì‹¤í–‰ ê³¼ì • ë¡œê·¸</h3>
                <button onclick="toggleLog()" class="toggle-log-btn" id="logToggleBtn">ì ‘ê¸°</button>
            </div>
            <div class="log-content" id="logContent">
                <div class="log-entry info">
                    <span class="log-timestamp">[ì‹œì‘]</span>
                    ì±„íŒ… í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== UTILITY FUNCTIONS =====
        const Utils = {
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            formatResponse(text) {
                if (!text) return '';
                
                let formatted = text;
                
                // Code blocks (```code```) - must be processed before inline code
                formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                
                // Inline code (`code`)
                formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Headers (# ## ### #### ##### ######)
                formatted = formatted.replace(/^#{6}\s+(.+)$/gm, '<h6>$1</h6>');
                formatted = formatted.replace(/^#{5}\s+(.+)$/gm, '<h5>$1</h5>');
                formatted = formatted.replace(/^#{4}\s+(.+)$/gm, '<h4>$1</h4>');
                formatted = formatted.replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>');
                formatted = formatted.replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>');
                formatted = formatted.replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>');
                
                // Bold text (**text** or __text__)
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>');
                
                // Italic text (*text* or _text_)
                formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
                formatted = formatted.replace(/_(.*?)_/g, '<em>$1</em>');
                
                // Strikethrough (~~text~~)
                formatted = formatted.replace(/~~(.*?)~~/g, '<del>$1</del>');
                
                // Links [text](url)
                formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
                
                // Images ![alt](url)
                formatted = formatted.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0;">');
                
                // Horizontal rules (--- or ***)
                formatted = formatted.replace(/^---$/gm, '<hr>');
                formatted = formatted.replace(/^\*\*\*$/gm, '<hr>');
                
                // Blockquotes (> text)
                formatted = formatted.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
                
                // Unordered lists (- item or * item)
                formatted = formatted.replace(/^[\s]*[-*]\s+(.+)$/gm, '<li>$1</li>');
                formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
                
                // Ordered lists (1. item)
                formatted = formatted.replace(/^[\s]*\d+\.\s+(.+)$/gm, '<li>$1</li>');
                
                // Tables (basic support)
                const lines = formatted.split('\n');
                let inTable = false;
                let tableHtml = '';
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const nextLine = lines[i + 1];
                    
                    // Check if this is a table header (contains |)
                    if (line.includes('|') && !line.trim().startsWith('<')) {
                        if (!inTable) {
                            inTable = true;
                            tableHtml = '<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">';
                        }
                        
                        // Skip separator lines (|---|---|)
                        if (line.match(/^\s*\|?[\s\-\|]+\|?\s*$/)) {
                            continue;
                        }
                        
                        // Process table row
                        const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
                        const isHeader = i === 0 || (nextLine && nextLine.match(/^\s*\|?[\s\-\|]+\|?\s*$/));
                        const tag = isHeader ? 'th' : 'td';
                        
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += `<${tag} style="border: 1px solid #ddd; padding: 8px; text-align: left;">${cell}</${tag}>`;
                        });
                        tableHtml += '</tr>';
                    } else {
                        if (inTable) {
                            tableHtml += '</table>';
                            processedLines.push(tableHtml);
                            inTable = false;
                            tableHtml = '';
                        }
                        processedLines.push(line);
                    }
                }
                
                if (inTable) {
                    tableHtml += '</table>';
                    processedLines.push(tableHtml);
                }
                
                formatted = processedLines.join('\n');
                
                // Convert line breaks to <br> (but preserve existing HTML)
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            },

            getCurrentTime() {
                return new Date().toLocaleTimeString();
            }
        };

        // ===== DISCUSSION MANAGER =====
        class DiscussionManager {
            constructor() {
                this.speeches = []; // ë°œí™” ëª©ë¡ (ìˆœì„œëŒ€ë¡œ)
                this.currentSpeech = null; // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë°œí™”
                this.info = {
                    topic: '',
                    speakers: [],
                    speakersText: '',
                    materials: '',
                    summary: ''
                };
            }

            reset() {
                this.speeches = [];
                this.currentSpeech = null;
                this.info = {
                    topic: '',
                    speakers: [],
                    speakersText: '',
                    materials: '',
                    summary: ''
                };
            }

            getSpeakerColors() {
                return {
                    'ë§ˆì¼€íŒ…Â·ë¸Œëœë“œ ì „ëµ ì „ë¬¸ê°€': '#E3F2FD',
                    'ë¬¸í™”Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ íŠ¸ë Œë“œ ì „ë¬¸ê°€': '#F3E5F5',
                    'í˜ì‹ Â·ìŠ¤íƒ€íŠ¸ì—… ë™í–¥ ì „ë¬¸ê°€': '#E8F5E8',
                    'ê³ ê°ê²½í—˜(CX)Â·ì„œë¹„ìŠ¤ í˜ì‹  ì „ë¬¸ê°€': '#FFF3E0',
                    'ì œí’ˆÂ·ê¸°ìˆ  í˜ì‹ (R&D) ì „ë¬¸ê°€': '#FCE4EC',
                    'í† ë¡  ì§„í–‰ì': '#F5F5F5'
                };
            }

            getSpeakerBorderColors() {
                return {
                    'ë§ˆì¼€íŒ…Â·ë¸Œëœë“œ ì „ëµ ì „ë¬¸ê°€': '#2196F3',
                    'ë¬¸í™”Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ íŠ¸ë Œë“œ ì „ë¬¸ê°€': '#9C27B0',
                    'í˜ì‹ Â·ìŠ¤íƒ€íŠ¸ì—… ë™í–¥ ì „ë¬¸ê°€': '#4CAF50',
                    'ê³ ê°ê²½í—˜(CX)Â·ì„œë¹„ìŠ¤ í˜ì‹  ì „ë¬¸ê°€': '#FF9800',
                    'ì œí’ˆÂ·ê¸°ìˆ  í˜ì‹ (R&D) ì „ë¬¸ê°€': '#E91E63',
                    'í† ë¡  ì§„í–‰ì': '#757575'
                };
            }

            // í† í°ì„ í˜„ì¬ ë°œí™”ì— ì¶”ê°€
            addToken(token, speaker, isComplete) {
                // ë°œí™”ìê°€ ë°”ë€Œì—ˆê±°ë‚˜ ìƒˆë¡œìš´ ë°œí™”ê°€ í•„ìš”í•œ ê²½ìš°
                if (!this.currentSpeech || 
                    this.currentSpeech.speaker !== speaker || 
                    this.currentSpeech.isComplete) {
                    
                    
                    // ì´ì „ ë°œí™”ê°€ ìˆìœ¼ë©´ ì™„ë£Œ ì²˜ë¦¬
                    if (this.currentSpeech) {
                        this.currentSpeech.isComplete = true;
                    }
                    
                    // ìƒˆë¡œìš´ ë°œí™” ì‹œì‘
                    this.currentSpeech = {
                        speaker: speaker,
                        content: '',
                        isComplete: false
                    };
                    this.speeches.push(this.currentSpeech);
                }

                // í† í° ì¶”ê°€ (ë¹ˆ í† í°ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
                if (this.currentSpeech && token && token.trim() !== '') {
                    this.currentSpeech.content += token;
                }
                
                // ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ (í† í°ì´ ë¹ˆ ê²½ìš°ì—ë„ ì™„ë£Œ ìƒíƒœëŠ” ì—…ë°ì´íŠ¸)
                if (this.currentSpeech) {
                    this.currentSpeech.isComplete = isComplete;
                }
            }

            generateDiscussionHTML() {
                let content = '';

                // í† ë¡  ì •ë³´
                if (this.info.topic) {
                    const isTyping = this.info.topic && !this.info.topic.endsWith('.') && !this.info.topic.endsWith('!') && !this.info.topic.endsWith('?');
                    content += this.createInfoBlock('ğŸ¯ í† ë¡  ì£¼ì œ', this.info.topic, '#E8F5E8', '#4CAF50', isTyping);
                }

                if (this.info.speakersText || (this.info.speakers && this.info.speakers.length > 0)) {
                    const speakersText = this.info.speakersText || this.info.speakers.join(', ');
                    const isTyping = this.info.speakersText && !this.info.speakersText.endsWith('.') && !this.info.speakersText.endsWith('!') && !this.info.speakersText.endsWith('?');
                    content += this.createInfoBlock('ğŸ‘¥ ì°¸ì—¬ ì „ë¬¸ê°€', speakersText, '#E3F2FD', '#2196F3', isTyping);
                }

                if (this.info.materials) {
                    const isTyping = this.info.materials && !this.info.materials.endsWith('.') && !this.info.materials.endsWith('!') && !this.info.materials.endsWith('?');
                    content += this.createInfoBlock('ğŸ“š ì°¸ê³  ìë£Œ', this.info.materials, '#FFF3E0', '#FF9800', isTyping);
                }

                // ë°œí™” ëª©ë¡ í‘œì‹œ
                for (const speech of this.speeches) {
                    if (speech.content.trim()) {
                        const speakerColor = this.getSpeakerColors()[speech.speaker] || '#F5F5F5';
                        const borderColor = this.getSpeakerBorderColors()[speech.speaker] || '#757575';
                        const showTypingCursor = !speech.isComplete;

                        content += this.createSpeechBlock(speech.speaker, speech.content, speakerColor, borderColor, showTypingCursor);
                    }
                }

                // í† ë¡  ìš”ì•½
                if (this.info.summary) {
                    const isTyping = this.info.summary && !this.info.summary.endsWith('.') && !this.info.summary.endsWith('!') && !this.info.summary.endsWith('?');
                    content += this.createInfoBlock('ğŸ“ WOW Point', this.info.summary, '#FFF9C4', '#F57F17', isTyping);
                }

                return content;
            }

            createInfoBlock(title, content, bgColor, borderColor, showTypingCursor = false) {
                return `
                    <div style="background-color: ${bgColor}; padding: 8px 12px; border-radius: 8px; margin: 4px 0; border-left: 4px solid ${borderColor};">
                        <strong style="color: #333; font-size: 0.9em;">${title}</strong><br>
                        ${Utils.formatResponse(content)}${showTypingCursor ? '<span class="typing-cursor" style="animation: blink 1s infinite;">|</span>' : ''}
                    </div>
                `;
            }

            createSpeechBlock(speakerName, content, bgColor, borderColor, showTypingCursor = false) {
                return `
                    <div style="background-color: ${bgColor}; padding: 8px 12px; border-radius: 8px; margin: 4px 0; border-left: 4px solid ${borderColor};">
                        <strong style="color: #333; font-size: 0.9em;">${speakerName}</strong><br>
                        ${Utils.formatResponse(content)}${showTypingCursor ? '<span class="typing-cursor" style="animation: blink 1s infinite;">|</span>' : ''}
                    </div>
                `;
            }
        }

        // ===== MAIN CHAT CLASS =====
        class ChatTest {
            constructor() {
                this.initializeElements();
                this.initializeState();
                this.bindEvents();
                this.discussionManager = new DiscussionManager();
                this.setupResizableLayout();
            }

            initializeElements() {
                this.apiUrl = document.getElementById('apiUrl');
                this.userId = document.getElementById('userId');
                this.sessionId = document.getElementById('sessionId');
                this.cookieValue = document.getElementById('cookieValue');
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatForm = document.getElementById('chatForm');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.statusText = document.getElementById('statusText');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.typingText = document.getElementById('typingText');
                this.logContent = document.getElementById('logContent');
                this.mainContainer = document.querySelector('.main-container');
                this.chatContainer = document.querySelector('.chat-container');
                this.executionLog = document.querySelector('.execution-log');
                this.resizer = document.getElementById('verticalResizer');
            }
                
            initializeState() {
                this.isConnected = false;
                this.fullResponse = ''; // ì „ì²´ ì‘ë‹µì„ ì €ì¥í•  ë³€ìˆ˜
                this.multiLLMResponse = ''; // MULTI_LLM ì‘ë‹µì„ ì €ì¥í•  ë³€ìˆ˜
                this.llmMessage = null; // LLM ì „ìš© ë©”ì‹œì§€ ìš”ì†Œ
                this.eventSequence = []; // ì´ë²¤íŠ¸ ìˆœì„œ ì¶”ì 
                this.currentEventIndex = 0; // í˜„ì¬ ì´ë²¤íŠ¸ ì¸ë±ìŠ¤
                this.combinedResponse = ''; // í†µí•©ëœ ì‘ë‹µ
                this.isStreamingComplete = false; // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì—¬ë¶€
                this.currentLLMMessage = null; // í˜„ì¬ LLM ë©”ì‹œì§€ ìš”ì†Œ
                this.currentMultiLLMMessage = null; // í˜„ì¬ MULTI_LLM ë©”ì‹œì§€ ìš”ì†Œ
                this.currentLLMRole = null; // í˜„ì¬ LLM ë°œí™”ì
                this.currentMultiLLMRole = null; // í˜„ì¬ MULTI_LLM ë°œí™”ì
                this.currentStatusMessage = null; // í˜„ì¬ STATUS ë©”ì‹œì§€ ìš”ì†Œ
                this.logStreamConnection = null; // ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
                this.currentSessionId = null; // í˜„ì¬ ì„¸ì…˜ ID ì €ì¥
                this.selectedTools = new Set(); // ì„ íƒëœ ë„êµ¬ ëª©ë¡
                this.updateStatus('disconnected', 'ì—°ê²° ëŒ€ê¸° ì¤‘...');
                this.ssoLoginAndExtractUserId();
                this.startLogStreaming(); // ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
                this.initializeToolFilters(); // ë„êµ¬ í•„í„° ì´ˆê¸°í™”
                
                // ì´ˆê¸° ì„¸ì…˜ ID ìƒì„± (UUID ì‚¬ìš©)
                const initialSessionId = Utils.generateUUID();
                this.currentSessionId = initialSessionId;
                this.sessionId.value = initialSessionId;
                this.addLogEntry(`ğŸ†” ì´ˆê¸° ì„¸ì…˜ ID ìƒì„±: ${initialSessionId}`, 'info');
            }

            // ===== RESIZABLE LAYOUT =====
            setupResizableLayout() {
                if (!this.mainContainer || !this.chatContainer || !this.executionLog || !this.resizer) return;

                const saved = this.getSavedSplit();
                if (saved && !this.executionLog.classList.contains('collapsed')) {
                    this.applySplit(saved);
                }

                let isDragging = false;
                let startX = 0;
                let startChatPercent = saved ?? 72; // default chat width percent

                const onMouseMove = (e) => {
                    if (!isDragging) return;
                    const rect = this.mainContainer.getBoundingClientRect();
                    const containerWidth = rect.width;
                    if (containerWidth <= 0) return;

                    const resizerWidth = this.resizer.getBoundingClientRect().width || 6;
                    const minChatPx = 380;
                    const minLogPx = 280;

                    // Position relative to container
                    let relativeX = e.clientX - rect.left;
                    // Convert to percent for chat panel (space left of resizer)
                    let chatPercent = (relativeX / containerWidth) * 100;

                    // Clamp by min widths
                    const minChatPercent = (minChatPx / containerWidth) * 100;
                    const minLogPercent = (minLogPx / containerWidth) * 100;
                    const maxChatPercent = 100 - minLogPercent - ((resizerWidth / containerWidth) * 100);
                    chatPercent = Math.max(minChatPercent, Math.min(maxChatPercent, chatPercent));

                    this.applySplit(chatPercent);
                    startChatPercent = chatPercent;
                };

                const stopDragging = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    this.mainContainer.classList.remove('resizing');
                    this.resizer.classList.remove('active');
                    this.saveSplit(startChatPercent);
                    window.removeEventListener('mousemove', onMouseMove);
                    window.removeEventListener('mouseup', stopDragging);
                };

                this.resizer.addEventListener('mousedown', (e) => {
                    if (this.executionLog.classList.contains('collapsed')) return;
                    isDragging = true;
                    startX = e.clientX;
                    this.mainContainer.classList.add('resizing');
                    this.resizer.classList.add('active');
                    window.addEventListener('mousemove', onMouseMove);
                    window.addEventListener('mouseup', stopDragging);
                });

                window.addEventListener('resize', () => {
                    const p = this.getSavedSplit();
                    if (p && !this.executionLog.classList.contains('collapsed')) {
                        this.applySplit(p);
                    }
                });
            }

            getSavedSplit() {
                try {
                    const v = localStorage.getItem('chat_log_split_percent');
                    const num = v ? parseFloat(v) : NaN;
                    if (Number.isFinite(num) && num > 0 && num < 100) return num;
                } catch (_) {}
                return null;
            }

            saveSplit(chatPercent) {
                try { localStorage.setItem('chat_log_split_percent', String(chatPercent)); } catch (_) {}
            }

            applySplit(chatPercent) {
                const rect = this.mainContainer.getBoundingClientRect();
                const containerWidth = rect.width || 1;
                const resizerWidth = this.resizer ? (this.resizer.getBoundingClientRect().width || 6) : 6;
                const resizerPercent = (resizerWidth / containerWidth) * 100;
                const logPercent = Math.max(0, 100 - chatPercent - resizerPercent);
                this.chatContainer.style.flex = `0 0 ${chatPercent}%`;
                this.executionLog.style.flex = `0 0 ${logPercent}%`;
            }

            bindEvents() {
                this.chatForm.addEventListener('submit', (e) => this.handleSubmit(e));
                this.cookieValue.addEventListener('input', () => this.ssoLoginAndExtractUserId());
                this.sessionId.addEventListener('input', () => this.updateSessionId());
            }

            // ===== TOOL FILTER MANAGEMENT =====
            initializeToolFilters() {
                const toolButtons = document.querySelectorAll('.tool-filter-btn');
                toolButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tool = button.getAttribute('data-tool');
                        this.toggleTool(tool);
                    });
                });
            }

            toggleTool(tool) {
                const button = document.getElementById(`tool-${tool}`);
                if (!button) return;

                if (this.selectedTools.has(tool)) {
                    this.selectedTools.delete(tool);
                    button.classList.remove('active');
                } else {
                    this.selectedTools.add(tool);
                    button.classList.add('active');
                }

                // ì„ íƒëœ ë„êµ¬ ë¡œê·¸ ì¶œë ¥
                const toolsList = Array.from(this.selectedTools).join(', ');
                if (toolsList) {
                    this.addLogEntry(`ğŸ”§ ë„êµ¬ í•„í„°: ${toolsList}`, 'info');
                } else {
                    this.addLogEntry(`ğŸ”§ ë„êµ¬ í•„í„°: ì—†ìŒ (ëª¨ë“  ë„êµ¬ ì‚¬ìš©)`, 'info');
                }
            }

            getSelectedToolsString() {
                if (this.selectedTools.size === 0) {
                    return null; // ì„ íƒëœ ë„êµ¬ê°€ ì—†ìœ¼ë©´ null ë°˜í™˜ (ëª¨ë“  ë„êµ¬ ì‚¬ìš©)
                }
                return Array.from(this.selectedTools).join(',');
            }

            // ===== SESSION MANAGEMENT =====
            updateSessionId() {
                const sessionIdValue = this.sessionId.value.trim();
                if (sessionIdValue) {
                    this.currentSessionId = sessionIdValue;
                    this.addLogEntry(`ğŸ†” ì„¸ì…˜ ID ì„¤ì •: ${sessionIdValue}`, 'info');
                } else {
                    this.currentSessionId = null;
                    this.addLogEntry(`ğŸ†” ì„¸ì…˜ ID ì´ˆê¸°í™”ë¨`, 'info');
                }
            }

            getSessionId() {
                // ì…ë ¥ í•„ë“œì— ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ í˜„ì¬ ì„¸ì…˜ ID ì‚¬ìš©, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                const inputSessionId = this.sessionId.value.trim();
                if (inputSessionId) {
                    return inputSessionId;
                }
                
                if (this.currentSessionId) {
                    return this.currentSessionId;
                }
                
                // ìƒˆë¡œìš´ ì„¸ì…˜ ID ìƒì„± (UUID ì‚¬ìš©)
                this.currentSessionId = Utils.generateUUID();
                this.sessionId.value = this.currentSessionId; // ì…ë ¥ í•„ë“œì—ë„ ì„¤ì •
                this.addLogEntry(`ğŸ†” ìƒˆ ì„¸ì…˜ ID ìƒì„±: ${this.currentSessionId}`, 'info');
                return this.currentSessionId;
            }

            // ===== LOG STREAMING =====
            async startLogStreaming() {
                try {
                    const apiBaseUrl = this.apiUrl.value.replace('/caia/api/v1/chat/stream', '');
                    const currentSessionId = this.getSessionId();
                    const logStreamUrl = `${apiBaseUrl}/logs/stream?session_id=${encodeURIComponent(currentSessionId)}`;
                    
                    this.addLogEntry(`ğŸ”— ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œì‘: ${logStreamUrl}`, 'info');
                    
                    const response = await fetch(logStreamUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/event-stream',
                            'Cache-Control': 'no-cache'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    this.logStreamConnection = response;
                    this.addLogEntry(`âœ… ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì„±ê³µ`, 'completed');
                    
                    // ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬
                    await this.handleLogStream(response);
                    
                } catch (error) {
                    this.addLogEntry(`âŒ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                    // 5ì´ˆ í›„ ì¬ì‹œë„
                    setTimeout(() => this.startLogStreaming(), 5000);
                }
            }

            async handleLogStream(response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                
                                if (data === '[DONE]') {
                                    this.addLogEntry(`ğŸ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ`, 'completed');
                                    return;
                                }

                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.event_type === 'STATUS') {
                                        this.handleServerLogEvent(parsed);
                                    }
                                } catch (e) {
                                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                                }
                            }
                        }
                    }
                } catch (error) {
                    this.addLogEntry(`âŒ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                } finally {
                    reader.releaseLock();
                    // ì—°ê²°ì´ ëŠì–´ì§„ ê²½ìš° ì¬ì—°ê²° ì‹œë„
                    setTimeout(() => this.startLogStreaming(), 3000);
                }
            }

            // ===== SSO LOGIN =====
            async ssoLoginAndExtractUserId() {
                if (!this.cookieValue || !this.userId) return;

                const ssolgenetExa = this.cookieValue.value.trim();
                if (!ssolgenetExa) {
                    this.userId.value = '';
                    return;
                }
                try {
                    this.addLogEntry(`ğŸ” SSO ë¡œê·¸ì¸ ì‹œì‘: ${ssolgenetExa.substring(0, 50)}...`, 'info');

                    const apiBaseUrl = this.apiUrl.value.replace('/caia/api/v1/chat/stream', '');
                    const ssoLoginUrl = `${apiBaseUrl}/caia/api/v1/user/sso_login?ssolgenet_exa=${encodeURIComponent(ssolgenetExa)}`;
                    
                    this.addLogEntry(`ğŸŒ SSO ë¡œê·¸ì¸ API í˜¸ì¶œ: ${ssoLoginUrl}`, 'info');
                    
                    const response = await fetch(ssoLoginUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Accept-Encoding': 'gzip, deflate, br, zstd',
                            'Accept-Language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
                            'Cache-Control': 'no-cache',
                            'Connection': 'keep-alive'
                        }
                    });

                    this.addLogEntry(`ğŸ“¡ SSO ë¡œê·¸ì¸ ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`, 'info');

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status && data.data && data.data.user_id) {
                            this.userId.value = data.data.user_id;
                            this.addLogEntry(`ğŸ‘¤ SSO ë¡œê·¸ì¸ ì„±ê³µ: ${data.data.user_id} (${data.data.name})`, 'completed');
                        } else {
                            this.userId.value = '';
                            this.addLogEntry(`âš ï¸ SSO ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.message || 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}`, 'error');
                        }
                    } else {
                        this.userId.value = '';
                        const errorText = await response.text();
                        this.addLogEntry(`âš ï¸ SSO ë¡œê·¸ì¸ ì‹¤íŒ¨: ${response.status} ${response.statusText}`, 'error');
                        this.addLogEntry(`ğŸ“„ ì˜¤ë¥˜ ë‚´ìš©: ${errorText}`, 'error');
                    }
                } catch (error) {
                    this.userId.value = '';
                    this.addLogEntry(`âš ï¸ SSO ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            }

            // ===== LOG MANAGEMENT =====
            addLogEntry(message, type = 'info', includeTimestamp = true) {
                if (!this.logContent) return;

                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                
                if (includeTimestamp && !message.includes(' - ')) {
                    // ë©”ì‹œì§€ì— íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
                    const timestamp = Utils.getCurrentTime();
                    logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
                } else {
                    // ë©”ì‹œì§€ì— ì´ë¯¸ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš°
                    logEntry.innerHTML = message;
                }
                
                this.logContent.appendChild(logEntry);
                
                // ë¡œê·¸ í•­ëª© ìˆ˜ ì œí•œ (ì„±ëŠ¥ ìµœì í™”)
                this.limitLogEntries();
                
                // ë¶€ë“œëŸ¬ìš´ ìë™ ìŠ¤í¬ë¡¤
                this.scrollLogToBottom();
            }

            scrollLogToBottom() {
                // ìë™ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
                // if (!this.logContent) return;
                // 
                // // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
                // requestAnimationFrame(() => {
                //     this.logContent.scrollTo({
                //         top: this.logContent.scrollHeight,
                //         behavior: 'smooth'
                //     });
                // });
            }

            // ë¡œê·¸ í•­ëª© ìˆ˜ ì œí•œ (ì„±ëŠ¥ ìµœì í™”)
            limitLogEntries() {
                if (!this.logContent) return;
                
                const maxEntries = 200; // ìµœëŒ€ 200ê°œ ë¡œê·¸ í•­ëª© ìœ ì§€
                const entries = this.logContent.querySelectorAll('.log-entry');
                
                if (entries.length > maxEntries) {
                    // ì˜¤ë˜ëœ ë¡œê·¸ í•­ëª©ë“¤ ì œê±°
                    const entriesToRemove = entries.length - maxEntries;
                    for (let i = 0; i < entriesToRemove; i++) {
                        entries[i].remove();
                    }
                }
            }

            clearLog() {
                if (this.logContent) {
                    this.logContent.innerHTML = '';
                }
            }

            // ===== STATUS MANAGEMENT =====
            updateStatus(status, text) {
                if (this.statusIndicator) {
                    this.statusIndicator.className = `status-indicator status-${status}`;
                }
                if (this.statusText) {
                    this.statusText.textContent = text;
                }
                this.isConnected = status === 'connected';
            }

            updateTypingText(message) {
                if (this.typingText) {
                    this.typingText.textContent = message;
                }
            }

            // ===== MESSAGE MANAGEMENT =====
            addMessage(content, isUser = false, isStreaming = false, eventType = null, llmRole = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
                
                let cssClasses = 'message-content';
                if (isStreaming) cssClasses += ' streaming';
                
                // ì´ë²¤íŠ¸ íƒ€ì…ë³„ CSS í´ë˜ìŠ¤ ì¶”ê°€
                if (eventType) {
                    cssClasses += ` event-${eventType.toLowerCase()}`;
                }
                
                // MULTI_LLMì˜ ê²½ìš° llm_roleë³„ CSS í´ë˜ìŠ¤ ì¶”ê°€
                if (eventType === 'MULTI_LLM' && llmRole) {
                    const roleClass = this.getRoleClass(llmRole);
                    if (roleClass) {
                        cssClasses += ` ${roleClass}`;
                        console.log('Added role class:', roleClass, 'for role:', llmRole);
                    }
                }
                
                console.log('Final CSS classes:', cssClasses);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = cssClasses;

                contentDiv.innerHTML = content;
                
                messageDiv.appendChild(contentDiv);
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                
                return contentDiv;
            }

            // llm_roleì„ CSS í´ë˜ìŠ¤ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
            getRoleClass(llmRole) {
                const roleMap = {
                    'HOST': 'role-host',
                    'CRISIS_EXPERT': 'role-crisis-expert',
                    'GLOBAL_MARKETING_EXPERT': 'role-global-marketing-expert',
                    'PRODUCT_EXPERT': 'role-product-expert',
                    'CX_EXPERT': 'role-cx-expert',
                    'TREND_EXPERT': 'role-trend-expert',
                    'STARTUP_EXPERT': 'role-startup-expert',
                    'BRAND_EXPERT': 'role-brand-expert',
                    'ë§ˆì¼€íŒ…Â·ë¸Œëœë“œ ì „ëµ ì „ë¬¸ê°€': 'role-brand-expert',
                    'ë¬¸í™”Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ íŠ¸ë Œë“œ ì „ë¬¸ê°€': 'role-trend-expert',
                    'í˜ì‹ Â·ìŠ¤íƒ€íŠ¸ì—… ë™í–¥ ì „ë¬¸ê°€': 'role-startup-expert',
                    'ê³ ê°ê²½í—˜(CX)Â·ì„œë¹„ìŠ¤ í˜ì‹  ì „ë¬¸ê°€': 'role-cx-expert',
                    'ì œí’ˆÂ·ê¸°ìˆ  í˜ì‹ (R&D) ì „ë¬¸ê°€': 'role-product-expert',
                    'í† ë¡  ì§„í–‰ì': 'role-host'
                };
                return roleMap[llmRole] || null;
            }

            scrollToBottom() {
                // ìë™ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
                // this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            // ===== FORM HANDLING =====
            async handleSubmit(e) {
                e.preventDefault();
                
                const message = this.chatInput.value.trim();
                if (!message) return;

                this.clearLog();
                this.addLogEntry(`ğŸš€ ì±„íŒ… ìš”ì²­ ì‹œì‘: "${message}"`, 'info');

                this.addMessage(message, true);
                this.chatInput.value = '';
                this.sendButton.disabled = true;
                this.updateStatus('connecting', 'ì—°ê²° ì¤‘...');

                this.typingIndicator.classList.add('show');

                try {
                    await this.sendMessage(message, null);
                } catch (error) {
                    this.addLogEntry(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    this.addMessage(`âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, false, false, 'ERROR');
                    this.updateStatus('disconnected', 'ì—°ê²° ì‹¤íŒ¨');
                } finally {
                    this.typingIndicator.classList.remove('show');
                    this.sendButton.disabled = false;
                }
            }

            // ===== API COMMUNICATION =====
            async sendMessage(message, assistantMessage) {
                let url = this.apiUrl.value;
                const userId = this.userId.value;
                const sessionId = this.getSessionId();
                const cookieValue = this.cookieValue.value;

                // ì„ íƒëœ ë„êµ¬ë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
                const selectedTools = this.getSelectedToolsString();
                if (selectedTools) {
                    try {
                        const urlObj = new URL(url);
                        urlObj.searchParams.set('tools', selectedTools);
                        url = urlObj.toString();
                    } catch (e) {
                        // URL íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ì§ì ‘ ì¶”ê°€
                        const separator = url.includes('?') ? '&' : '?';
                        url = `${url}${separator}tools=${encodeURIComponent(selectedTools)}`;
                    }
                }

                const cookies = {};
                if (cookieValue) {
                    cookieValue.split(';').forEach(cookie => {
                        const [name, value] = cookie.trim().split('=');
                        if (name && value) {
                            cookies[name] = value;
                        }
                    });
                }

                const requestBody = {
                    question: message,
                    user_id: userId,
                    message_filter: "LGE",
                    chat_filter: "LGSSCHAT",
                    chat_group_id: sessionId,
                    api_version: "GPT4.1-CHAT",
                    meta: {
                        user_id: ["lge_raih_info", "lge_map"],
                        file_document_id: []
                    },
                    checked: false
                };

                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream',
                    'Cache-Control': 'no-cache'
                };

                if (Object.keys(cookies).length > 0) {
                    headers['Cookie'] = Object.entries(cookies)
                        .map(([name, value]) => `${name}=${value}`)
                        .join('; ');
                }

                this.addLogEntry(`ğŸ“¤ ìš”ì²­ ì „ì†¡: ${url}`, 'info');
                this.addLogEntry(`ğŸ‘¤ User ID: ${userId}`, 'info');
                this.addLogEntry(`ğŸ†” Session ID: ${sessionId}`, 'info');
                if (selectedTools) {
                    this.addLogEntry(`ğŸ”§ ë„êµ¬ í•„í„°: ${selectedTools}`, 'info');
                }
                this.addLogEntry(`ğŸª Cookie: ${cookieValue.substring(0, 50)}...`, 'info');

                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                this.addLogEntry(`âœ… ì‘ë‹µ ìˆ˜ì‹ : ${response.status} ${response.statusText}`, 'completed');
                this.updateStatus('connected', 'ì—°ê²°ë¨');
                await this.handleStreamResponse(response, assistantMessage);
            }

            // ===== STREAM RESPONSE HANDLING =====
            async handleStreamResponse(response, assistantMessage) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                this.fullResponse = ''; // ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ì´ˆê¸°í™”
                this.multiLLMResponse = ''; // MULTI_LLM ì‘ë‹µ ë²„í¼ ì´ˆê¸°í™”
                this.llmMessage = null; // LLM ì „ìš© ë©”ì‹œì§€ ì´ˆê¸°í™”
                this.currentAssistantMessage = assistantMessage; // í˜„ì¬ í™œì„± ë©”ì‹œì§€ ì¶”ì 
                this.eventSequence = []; // ì´ë²¤íŠ¸ ìˆœì„œ ì´ˆê¸°í™”
                this.currentEventIndex = 0; // ì´ë²¤íŠ¸ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
                this.combinedResponse = ''; // í†µí•©ëœ ì‘ë‹µ ì´ˆê¸°í™”
                this.isStreamingComplete = false; // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì—¬ë¶€ ì´ˆê¸°í™”
                this.currentLLMMessage = null; // í˜„ì¬ LLM ë©”ì‹œì§€ ì´ˆê¸°í™”
                this.currentMultiLLMMessage = null; // í˜„ì¬ MULTI_LLM ë©”ì‹œì§€ ì´ˆê¸°í™”
                this.currentLLMRole = null; // í˜„ì¬ LLM ë°œí™”ì ì´ˆê¸°í™”
                this.currentMultiLLMRole = null; // í˜„ì¬ MULTI_LLM ë°œí™”ì ì´ˆê¸°í™”
                this.currentStatusMessage = null; // í˜„ì¬ STATUS ë©”ì‹œì§€ ì´ˆê¸°í™”
                let isCompleted = false;

                try {
                    while (true) {
                        let done, value;
                        try {
                            const readPromise = reader.read();
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Read timeout')), 10000)
                            );
                            
                            const result = await Promise.race([readPromise, timeoutPromise]);
                            done = result.done;
                            value = result.value;
                            
                            if (done) break;
                        } catch (readError) {
                            if (readError.message === 'Read timeout') {
                                continue;
                            }
                            break;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                            
                                if (data === '[DONE]') {
                                    if (assistantMessage) {
                                        assistantMessage.classList.remove('streaming');
                                    }
                                    this.updateStatus('connected', 'ì—°ê²°ë¨');
                                    return;
                                }

                                try {
                                    const parsed = JSON.parse(data);
                                    this.handleSSEEvent(parsed);
                                } catch (e) {
                                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                                }
                            }
                        }
                    }
                } catch (error) {
                    if (assistantMessage) {
                        assistantMessage.innerHTML = `âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                        assistantMessage.classList.remove('streaming');
                    } else {
                        // assistantMessageê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                        this.addMessage(`âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, false, false, 'ERROR');
                    }
                    this.updateStatus('disconnected', 'ì˜¤ë¥˜ ë°œìƒ');
                } finally {
                    reader.releaseLock();
                    
                    if (!isCompleted) {
                        if (assistantMessage) {
                            assistantMessage.classList.remove('streaming');
                        }
                        this.updateStatus('connected', 'ì—°ê²°ë¨');
                    }
                }
            }

            // ===== SSE EVENT HANDLING =====
            handleSSEEvent(parsed) {
                console.log('SSE Event received:', parsed.event_type, parsed);
                switch (parsed.event_type) {
                    case 'INIT':
                        this.addLogEntry(`ğŸš€ AI ë‹µë³€ ì‹œì‘`, 'info');
                        break;
                    
                    case 'STATUS':
                        this.handleStatusEvent(parsed);
                        break;
                    
                    case 'ANALYSIS_STATUS':
                        if (parsed.event_data && parsed.event_data.status) {
                            this.addLogEntry(`ğŸ” ANALYSIS_STATUS: ${parsed.event_data.status}`, 'processing');
                            // ANALYSIS_STATUS ì´ë²¤íŠ¸ëŠ” ë¡œê·¸ë§Œ í‘œì‹œí•˜ê³  ë©”ì‹œì§€ëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
                        }
                        break;
                                    
                    case 'LLM':
                        this.handleLLMEvent(parsed);
                        break;
                                    
                    case 'MULTI_LLM':
                        this.handleMultiLLMEvent(parsed);
                        break;
                                    
                    case 'ACTION_BUTTON':
                        this.handleActionButtonEvent(parsed);
                        break;
                                    
                    case 'USER_SEARCH':
                        this.handleUserSearchEvent(parsed);
                        break;
                                    
                    case 'MAIL_TO_EVENT':
                        this.handleMailToEventEvent(parsed);
                        break;
                                    
                    case 'MAIL_TODO_BRIEFING':
                        this.handleMailTodoBriefingEvent(parsed);
                        break;
                                    
                    case 'MAIL_LINK':
                        this.handleMailLinkEvent(parsed);
                        break;
                                    
                    case 'EVENT_LINK':
                        this.handleEventLinkEvent(parsed);
                        break;
                                    
                    case 'PERSON_IN_CHARGE_SEARCH':
                        this.handlePersonInChargeSearchEvent(parsed);
                        break;
                                    
                    case 'DOCUMENTS':
                        this.handleDocumentsEvent(parsed);
                        break;
                                    
                    case 'QUESTION_SUGGEST':
                        this.handleQuestionSuggestEvent(parsed);
                        break;
                                    
                    case 'SERVER_LOG':
                        this.handleServerLogEvent(parsed);
                        break;
                                    
                    case 'CLOSE':
                        this.addLogEntry(`ğŸ AI ë‹µë³€ ì™„ë£Œ`, 'completed');
                        // CLOSE ì´ë²¤íŠ¸ ì‹œ STATUS ë©”ì‹œì§€ ì œê±°
                        if (this.currentStatusMessage) {
                            this.currentStatusMessage.parentElement.remove();
                            this.currentStatusMessage = null;
                        }
                        // CLOSE ì´ë²¤íŠ¸ëŠ” ë¡œê·¸ë§Œ í‘œì‹œ
                        this.updateStatus('connected', 'ì—°ê²°ë¨');
                        break;
                                    
                    case 'ERROR':
                        this.addLogEntry(`âŒ ì˜¤ë¥˜: ${parsed.token || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                        // ERROR ì´ë²¤íŠ¸ëŠ” ìƒˆë¡œìš´ ë©”ì‹œì§€ë¡œ í‘œì‹œ
                        const errorMessage = `âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${parsed.token || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                        this.addMessage(errorMessage, false, false, 'ERROR');
                        this.updateStatus('disconnected', 'ì˜¤ë¥˜ ë°œìƒ');
                        break;
                                    
                    case 'TOOL_COMPLETE':
                        if (parsed.event_data && parsed.event_data.message) {
                            this.addLogEntry(`âœ… ${parsed.event_data.message}`, 'completed');
                        }
                        break;
                                    
                    case 'DISCUSSION_START':
                        this.addLogEntry(`ğŸ¯ í† ë¡  ì‹œì‘: ${parsed.event_data?.message || 'í† ë¡ ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...'}`, 'processing');
                        this.discussionManager.reset();
                        break;
                    
                    case 'DISCUSSION_TOPIC':
                        this.handleDiscussionTopic(parsed);
                        break;
                    
                    case 'DISCUSSION_SPEAKERS':
                        this.handleDiscussionSpeakers(parsed);
                        break;
                    
                    case 'DISCUSSION_MATERIALS':
                        this.handleDiscussionMaterials(parsed);
                        break;
                    
                    case 'DISCUSSION_RUNNING':
                        this.handleDiscussionRunning(parsed);
                        break;
                    
                    case 'DISCUSSION_RESULT':
                        this.handleDiscussionResult(parsed);
                        break;
                    
                    case 'DISCUSSION_NODE':
                        const nodeMessage = parsed.event_data?.message || 'í† ë¡  ë…¸ë“œë¥¼ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                        this.addLogEntry(`ğŸ”„ ${nodeMessage}`, 'processing');
                        break;
                    
                    case 'DISCUSSION_END':
                        this.addLogEntry(`âœ… í† ë¡  ì™„ë£Œ`, 'completed');
                        this.finalizeDiscussionDisplay();
                        break;
                }
            }

            // ===== NEW EVENT HANDLERS =====
            handleLLMEvent(parsed) {
                // done: trueì¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
                if (parsed.done === true) {
                    this.addLogEntry(`ğŸ LLM ì‘ë‹µ ì™„ë£Œ`, 'completed');
                    // done: trueì¸ ê²½ìš° í˜„ì¬ LLM ë©”ì‹œì§€ ì™„ë£Œ ì²˜ë¦¬ ë° ì¤„ë°”ê¿ˆ ì¶”ê°€
                    if (this.currentLLMMessage) {
                        this.currentLLMMessage.classList.remove('streaming');
                        // ë‘ ì¤„ ë°”ê¿ˆ ì¶”ê°€
                        this.fullResponse += '\n\n';
                        const formattedResponse = Utils.formatResponse(this.fullResponse);
                        this.currentLLMMessage.innerHTML = formattedResponse;
                        this.scrollToBottom();
                    }
                    // ë°œí™”ì ì •ë³´ ë° ë©”ì‹œì§€ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ë°œí™”ìë¥¼ ìœ„í•´)
                    this.currentLLMRole = null;
                    this.currentLLMMessage = null;
                    return;
                }

                // done: falseì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
                if (parsed.token !== undefined && parsed.token !== '') {
                    // ì²« ë²ˆì§¸ í† í°ì¸ ê²½ìš° ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    if (!this.currentLLMMessage) {
                        // ë°œí™”ì ì •ë³´ ì„¤ì •
                        this.currentLLMRole = parsed.event_data?.llm_role || 'LLM';
                        
                        // ë°œí™”ì ì •ë³´ê°€ ìˆìœ¼ë©´ ë©”ì‹œì§€ì— í¬í•¨
                        let initialContent = '';
                        if (this.currentLLMRole && this.currentLLMRole !== 'LLM') {
                            initialContent = `**${this.currentLLMRole}**\n\n`;
                        }
                        
                        this.currentLLMMessage = this.addMessage(initialContent, false, true, 'LLM');
                        this.fullResponse = initialContent;
                    }
                    
                    // í† í° ì¶”ê°€ (í•œê¸€ìì”© ìŠ¤íŠ¸ë¦¬ë°)
                    this.fullResponse += parsed.token;
                    const formattedResponse = Utils.formatResponse(this.fullResponse) + '<span class="typing-cursor">|</span>';
                    
                    // ìì—°ìŠ¤ëŸ¬ìš´ íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì•½ê°„ì˜ ì§€ì—°
                    setTimeout(() => {
                        this.currentLLMMessage.innerHTML = formattedResponse;
                        this.scrollToBottom();
                    }, 10);
                }
            }

            handleMultiLLMEvent(parsed) {
                // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
                console.log('MULTI_LLM Event:', parsed);
                
                // done: trueì¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
                if (parsed.done === true) {
                    this.addLogEntry(`ğŸ MULTI_LLM ì‘ë‹µ ì™„ë£Œ`, 'completed');
                    // done: trueì¸ ê²½ìš° í˜„ì¬ MULTI_LLM ë©”ì‹œì§€ ì™„ë£Œ ì²˜ë¦¬ ë° ì¤„ë°”ê¿ˆ ì¶”ê°€
                    if (this.currentMultiLLMMessage) {
                        this.currentMultiLLMMessage.classList.remove('streaming');
                        // ë‘ ì¤„ ë°”ê¿ˆ ì¶”ê°€
                        this.multiLLMResponse += '\n\n';
                        const formattedResponse = Utils.formatResponse(this.multiLLMResponse);
                        this.currentMultiLLMMessage.innerHTML = formattedResponse;
                        this.scrollToBottom();
                    }
                    // ë°œí™”ì ì •ë³´ ë° ë©”ì‹œì§€ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ë°œí™”ìë¥¼ ìœ„í•´)
                    this.currentMultiLLMRole = null;
                    this.currentMultiLLMMessage = null;
                    return;
                }

                // done: falseì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
                if (parsed.token) {
                    // ì²« ë²ˆì§¸ í† í°ì¸ ê²½ìš° ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    if (!this.currentMultiLLMMessage) {
                        // ë°œí™”ì ì •ë³´ ì„¤ì •
                        this.currentMultiLLMRole = parsed.event_data?.llm_role || '';
                        console.log('New MULTI_LLM speaker:', this.currentMultiLLMRole);
                        
                        // ë°œí™”ì ì •ë³´ê°€ ìˆìœ¼ë©´ ë©”ì‹œì§€ì— í¬í•¨
                        let initialContent = '';
                        if (this.currentMultiLLMRole) {
                            initialContent = `**${this.currentMultiLLMRole}**\n\n`;
                        }
                        
                        this.currentMultiLLMMessage = this.addMessage(initialContent, false, true, 'MULTI_LLM', this.currentMultiLLMRole);
                        this.multiLLMResponse = initialContent;
                    }
                    
                    // í† í° ì¶”ê°€ (í•œê¸€ìì”© ìŠ¤íŠ¸ë¦¬ë°)
                    this.multiLLMResponse += parsed.token;
                    const formattedResponse = Utils.formatResponse(this.multiLLMResponse) + '<span class="typing-cursor">|</span>';
                    
                    // ìì—°ìŠ¤ëŸ¬ìš´ íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì•½ê°„ì˜ ì§€ì—°
                    setTimeout(() => {
                        this.currentMultiLLMMessage.innerHTML = formattedResponse;
                        this.scrollToBottom();
                    }, 10);
                }
            }

            handleActionButtonEvent(parsed) {
                if (parsed.event_data && parsed.event_data.buttons) {
                    let content = '**ì•¡ì…˜ ë²„íŠ¼:**\n\n';
                    parsed.event_data.buttons.forEach(button => {
                        const actionType = button.action.type;
                        const actionValue = button.action.value;
                        content += `ğŸ”˜ **${button.text}**\n`;
                        content += `   - íƒ€ì…: ${actionType}\n`;
                        content += `   - ê°’: ${actionValue}\n\n`;
                    });
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'ACTION_BUTTON');
                }
            }

            handleUserSearchEvent(parsed) {
                if (parsed.event_data && parsed.event_data.users) {
                    let content = '**ì‚¬ìš©ì ê²€ìƒ‰ ê²°ê³¼:**\n\n';
                    parsed.event_data.users.forEach(user => {
                        content += `ğŸ‘¤ **${user.user_name}**\n`;
                        content += `   - ID: ${user.user_id}\n`;
                        content += `   - ì§ì±…: ${user.position}\n`;
                        content += `   - íŒ€: ${user.team}\n`;
                        content += `   - ì´ë©”ì¼: ${user.email}\n`;
                        content += `   - ìœ„ì¹˜: ${user.location}\n\n`;
                    });
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'USER_SEARCH');
                }
            }

            handleMailToEventEvent(parsed) {
                if (parsed.event_data && parsed.event_data.meetings) {
                    let content = '**ğŸ“§ ì´ë©”ì¼ â†’ ì¼ì • ë³€í™˜:**\n\n';
                    parsed.event_data.meetings.forEach(meeting => {
                        content += `ğŸ“… **${meeting.title}**\n`;
                        content += `   - ì‹œì‘: ${meeting.start_datetime.datetime}\n`;
                        content += `   - ì¢…ë£Œ: ${meeting.end_datetime.datetime}\n`;
                        content += `   - ì¥ì†Œ: ${meeting.location}\n`;
                        content += `   - ì°¸ì„ì: ${meeting.attendees.join(', ')}\n`;
                        content += `   - ì„¤ëª…: ${meeting.description}\n\n`;
                    });
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'MAIL_TO_EVENT');
                }
            }

            handleMailTodoBriefingEvent(parsed) {
                if (parsed.event_data) {
                    const data = parsed.event_data;
                    let content = '**ğŸ“§ ì´ë©”ì¼ í• ì¼ ë¸Œë¦¬í•‘:**\n\n';
                    
                    if (data.total_summary) {
                        content += `ğŸ“‹ **ì „ì²´ ìš”ì•½:**\n${data.total_summary}\n\n`;
                    }
                    
                    if (data.to_do_list && data.to_do_list.length > 0) {
                        content += `âœ… **í• ì¼ ëª©ë¡:**\n`;
                        data.to_do_list.forEach(todo => {
                            content += `- **${todo.type}**: ${todo.summary}\n`;
                            if (todo.description) content += `  ${todo.description}\n`;
                            if (todo.due_date) content += `  ğŸ“… ë§ˆê°: ${todo.due_date}\n`;
                        });
                        content += '\n';
                    }
                    
                    if (data.meetings_for_create && data.meetings_for_create.length > 0) {
                        content += `ğŸ“… **ìƒì„±í•  íšŒì˜:**\n`;
                        data.meetings_for_create.forEach(meeting => {
                            content += `- **${meeting.title}**\n`;
                            content += `  ğŸ“… ${meeting.start_datetime.datetime} ~ ${meeting.end_datetime.datetime}\n`;
                        });
                    }
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'MAIL_TODO_BRIEFING');
                }
            }

            handleMailLinkEvent(parsed) {
                if (parsed.event_data && parsed.event_data.links) {
                    let content = '**ğŸ“§ ì´ë©”ì¼ ë§í¬:**\n\n';
                    parsed.event_data.links.forEach(link => {
                        content += `ğŸ“ **${link.file_name}**\n`;
                        content += `   - íƒ€ì…: ${link.content_type}\n`;
                        content += `   - ì†ŒìŠ¤: ${link.source_type}\n`;
                        content += `   - URL: ${link.source_url}\n\n`;
                    });
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'MAIL_LINK');
                }
            }

            handleEventLinkEvent(parsed) {
                if (parsed.event_data && parsed.event_data.links) {
                    let content = '**ğŸ“… ì¼ì • ë§í¬:**\n\n';
                    parsed.event_data.links.forEach(link => {
                        content += `ğŸ“ **${link.file_name}**\n`;
                        content += `   - íƒ€ì…: ${link.content_type}\n`;
                        content += `   - ì†ŒìŠ¤: ${link.source_type}\n`;
                        content += `   - URL: ${link.source_url}\n\n`;
                    });
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'EVENT_LINK');
                }
            }

            handlePersonInChargeSearchEvent(parsed) {
                if (parsed.event_data && parsed.event_data.person) {
                    const person = parsed.event_data.person;
                    let content = '**ğŸ‘¤ ë‹´ë‹¹ì ì •ë³´:**\n\n';
                    content += `ğŸ‘¤ **${person.user_name}**\n`;
                    content += `   - ID: ${person.user_id}\n`;
                    content += `   - ì§ì±…: ${person.position}\n`;
                    content += `   - íŒ€: ${person.team}\n`;
                    content += `   - ì´ë©”ì¼: ${person.email}\n`;
                    content += `   - ìœ„ì¹˜: ${person.location}\n`;
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'PERSON_IN_CHARGE_SEARCH');
                }
            }

            handleDocumentsEvent(parsed) {
                if (parsed.event_data && parsed.event_data.documents) {
                    let content = '**ğŸ“š ê²€ìƒ‰ëœ ë¬¸ì„œ:**\n\n';
                    Object.values(parsed.event_data.documents).forEach(doc => {
                        content += `ğŸ“„ **${doc.title}**\n`;
                        content += `   - ì ìˆ˜: ${doc.score}\n`;
                        content += `   - íŒŒì¼ëª…: ${doc.filename}\n`;
                        content += `   - í™•ì¥ì: ${doc.extension}\n`;
                        content += `   - ì¹´í…Œê³ ë¦¬: ${doc.category_no}\n`;
                        if (doc.view_url) content += `   - ë³´ê¸°: ${doc.view_url}\n`;
                        content += `   - ë‚´ìš©: ${doc.context.substring(0, 100)}...\n\n`;
                    });
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(content, false, false, 'DOCUMENTS');
                }
            }

            handleStatusEvent(parsed) {
                if (!parsed.event_data) return;
                
                // event_data.statusê°€ ìˆìœ¼ë©´ ì±„íŒ…ì°½ì— í‘œì‹œ (DiscussionStatusEventData)
                if (parsed.event_data.status) {
                    const statusText = parsed.event_data.status;
                    
                    // ê¸°ì¡´ STATUS ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    if (this.currentStatusMessage) {
                        // ê¸°ì¡´ ë©”ì‹œì§€ ë‚´ìš© ì—…ë°ì´íŠ¸
                        const statusContent = `<span class="status-icon">ğŸ”„</span> **${statusText}**`;
                        this.currentStatusMessage.innerHTML = Utils.formatResponse(statusContent);
                    } else {
                        // ìƒˆë¡œìš´ STATUS ë©”ì‹œì§€ ìƒì„±
                        const statusContent = `<span class="status-icon">ğŸ”„</span> **${statusText}**`;
                        this.currentStatusMessage = this.addMessage(statusContent, false, false, 'STATUS');
                    }
                }
                // event_data.log_levelì´ ìˆìœ¼ë©´ ë¡œê·¸ì— í‘œì‹œ (ServerLogEventData)
                else if (parsed.event_data.log_level) {
                    this.handleServerLogEvent(parsed);
                }
            }

            handleQuestionSuggestEvent(parsed) {
                if (parsed.event_data && parsed.event_data.questions) {
                    const questions = parsed.event_data.questions;
                    if (Array.isArray(questions) && questions.length > 0) {
                        // í•˜ë‚˜ì˜ ë©”ì‹œì§€ì— ëª¨ë“  ì§ˆë¬¸ì„ í´ë¦­ ê°€ëŠ¥í•œ ë§í’ì„ ìœ¼ë¡œ í‘œì‹œ
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message assistant';
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'message-content event-question-suggest';
                        
                        // ê° ì§ˆë¬¸ì„ í´ë¦­ ê°€ëŠ¥í•œ ì•„ì´í…œìœ¼ë¡œ ìƒì„±
                        questions.forEach((question) => {
                            const questionDiv = document.createElement('div');
                            questionDiv.className = 'question-suggest-item';
                            questionDiv.textContent = `ğŸ’¡ ${question}`;
                            questionDiv.setAttribute('data-question', question);
                            questionDiv.addEventListener('click', () => {
                                this.selectQuestion(question);
                            });
                            contentDiv.appendChild(questionDiv);
                        });
                        
                        messageDiv.appendChild(contentDiv);
                        this.chatMessages.appendChild(messageDiv);
                        this.scrollToBottom();
                    }
                }
            }

            selectQuestion(question) {
                // ì§ˆë¬¸ì„ ì¿¼ë¦¬ì°½ì— ì…ë ¥
                if (this.chatInput) {
                    this.chatInput.value = question;
                    this.chatInput.focus();
                    this.addLogEntry(`ğŸ’¡ ì§ˆë¬¸ ì„ íƒ: ${question}`, 'info');
                }
            }

            handleServerLogEvent(parsed) {
                if (parsed.event_data) {
                    const logData = parsed.event_data;
                    const timestamp = logData.timestamp || Utils.getCurrentTime();
                    const logLevel = logData.log_level || 'INFO';
                    const loggerName = logData.logger_name || 'unknown';
                    const message = logData.message || '';
                    const sessionId = logData.session_id || '';
                    
                    // í˜„ì¬ ì„¸ì…˜ì˜ ë¡œê·¸ë§Œ í‘œì‹œ (ì„¸ì…˜ IDê°€ ì—†ê±°ë‚˜ í˜„ì¬ ì„¸ì…˜ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°)
                    const currentSessionId = this.getSessionId();
                    if (sessionId && sessionId !== currentSessionId) {
                        return; // ë‹¤ë¥¸ ì„¸ì…˜ì˜ ë¡œê·¸ëŠ” ë¬´ì‹œ
                    }
                    
                    // Health check ë¡œê·¸ í•„í„°ë§
                    if (message.includes('[HEALTH]') || message.includes('Health check')) {
                        return; // Health check ë¡œê·¸ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    }
                    
                    // INFO ë ˆë²¨ë§Œ ë¡œê·¸ì— í‘œì‹œ
                    if (logLevel !== 'INFO') {
                        return; // INFOê°€ ì•„ë‹Œ ë¡œê·¸ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    }
                    
                    // ì„œë²„ ë¡œê·¸ë¥¼ ìš°ì¸¡ ë¡œê·¸ íŒ¨ë„ì— í‘œì‹œ (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
                    this.addLogEntry(`${timestamp} - ${loggerName} - ${logLevel} - ${message}`, 'info', false);
                }
            }

            // ===== DISCUSSION EVENT HANDLERS =====
            handleDiscussionTopic(parsed) {
                if (parsed.token !== undefined && parsed.token !== '') {
                    if (!this.discussionManager.info.topic) {
                        this.discussionManager.info.topic = '';
                    }
                    this.discussionManager.info.topic += parsed.token;
                    // íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—° í›„ í™”ë©´ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        this.updateDiscussionDisplay();
                    }, 50);
                } else if (parsed.event_data && parsed.event_data.topic) {
                    this.discussionManager.info.topic = parsed.event_data.topic;
                    this.updateDiscussionDisplay();
                }
            }

            handleDiscussionSpeakers(parsed) {
                if (parsed.token !== undefined && parsed.token !== '') {
                    if (!this.discussionManager.info.speakersText) {
                        this.discussionManager.info.speakersText = '';
                    }
                    this.discussionManager.info.speakersText += parsed.token;
                    // íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—° í›„ í™”ë©´ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        this.updateDiscussionDisplay();
                    }, 50);
                } else if (parsed.event_data && parsed.event_data.speakers) {
                    const speakers = parsed.event_data.speakers;
                    this.discussionManager.info.speakers = speakers;
                    this.discussionManager.info.speakersText = speakers.join(', ');
                    this.updateDiscussionDisplay();
                }
            }

            handleDiscussionMaterials(parsed) {
                if (parsed.token !== undefined && parsed.token !== '') {
                    if (!this.discussionManager.info.materials) {
                        this.discussionManager.info.materials = '';
                    }
                    this.discussionManager.info.materials += parsed.token;
                    // íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—° í›„ í™”ë©´ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        this.updateDiscussionDisplay();
                    }, 50);
                } else if (parsed.event_data) {
                    const materials = parsed.event_data.materials || [];
                    const error = parsed.event_data.error;
                    
                    if (materials.length > 0) {
                        this.discussionManager.info.materials = `${materials.length}ê°œ ìë£Œ ìˆ˜ì§‘ ì™„ë£Œ`;
                    } else if (error) {
                        this.discussionManager.info.materials = error;
                    }
                    
                    this.updateDiscussionDisplay();
                }
            }

            handleDiscussionRunning(parsed) {
                const isDone = parsed.done === true;
                
                if (parsed.token !== undefined && parsed.token !== '') {
                    const speaker = parsed.event_data?.speaker || '';
                    const isComplete = parsed.event_data?.is_complete || false;
                    const message = parsed.event_data?.message || '';
                    
                    if (message.includes('ë°œì–¸í•  ì°¨ë¡€ì…ë‹ˆë‹¤')) {
                        this.addLogEntry(`ğŸ¤ ${message}`, 'processing');
                        // ìƒˆë¡œìš´ ë°œí™”ì ì‹œì‘ - ì´ì „ ë°œí™” ì™„ë£Œ ì²˜ë¦¬
                        if (this.discussionManager.currentSpeech) {
                            this.discussionManager.currentSpeech.isComplete = true;
                        }
                    } else if (message.includes('ë°œì–¸ì„ ì‹œì‘í•©ë‹ˆë‹¤')) {
                        this.addLogEntry(`ğŸ—£ï¸ ${message}`, 'processing');
                        // ìƒˆë¡œìš´ ë°œí™” ì‹œì‘
                        if (this.discussionManager.currentSpeech) {
                            this.discussionManager.currentSpeech.isComplete = true;
                        }
                        this.discussionManager.currentSpeech = {
                            speaker: speaker,
                            content: '',
                            isComplete: false
                        };
                        this.discussionManager.speeches.push(this.discussionManager.currentSpeech);
                    } else {
                        
                        // í† í°ì„ í˜„ì¬ ë°œí™”ì— ì¶”ê°€
                        this.discussionManager.addToken(parsed.token, speaker, isComplete || isDone);
                        
                        // íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—° í›„ í™”ë©´ ì—…ë°ì´íŠ¸
                        setTimeout(() => {
                            this.updateDiscussionDisplay();
                        }, 50);
                    }
                } else if (parsed.event_data && parsed.event_data.error) {
                    const error = parsed.event_data.error;
                    const errorContent = `ğŸ’¬ **í† ë¡  ì§„í–‰**\n${error}\n\n`;
                    
                    // ìƒˆë¡œìš´ ë©”ì‹œì§€ ìƒì„±
                    this.addMessage(errorContent, false, false, 'DISCUSSION_RUNNING');
                } else if (isDone) {
                    // DONE: trueì¸ ê²½ìš° í˜„ì¬ ë°œí™” ì™„ë£Œ ì²˜ë¦¬
                    const speaker = parsed.event_data?.speaker || '';
                    if (speaker && this.discussionManager.currentSpeech) {
                        this.discussionManager.currentSpeech.isComplete = true;
                        this.updateDiscussionDisplay();
                    }
                }
            }

            handleDiscussionResult(parsed) {
                if (parsed.token !== undefined && parsed.token !== '') {
                    if (!this.discussionManager.info.summary) {
                        this.discussionManager.info.summary = '';
                    }
                    this.discussionManager.info.summary += parsed.token;
                    // íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—° í›„ í™”ë©´ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        this.updateDiscussionDisplay();
                    }, 50);
                } else if (parsed.event_data && parsed.event_data.summary) {
                    this.discussionManager.info.summary = parsed.event_data.summary;
                    this.updateDiscussionDisplay();
                }
            }

            // ===== DISPLAY UPDATES =====
            updateDiscussionDisplay() {
                const content = this.discussionManager.generateDiscussionHTML();
                
                requestAnimationFrame(() => {
                    this.currentAssistantMessage.innerHTML = content;
                    this.scrollToBottom();
                });
            }

            finalizeDiscussionDisplay() {
                const content = this.discussionManager.generateDiscussionHTML();
                
                requestAnimationFrame(() => {
                    this.currentAssistantMessage.innerHTML = content;
                    this.currentAssistantMessage.classList.remove('streaming');
                    this.scrollToBottom();
                });
            }

        }

        // ===== GLOBAL FUNCTIONS =====

        function testUserSearch() {
            const chatTest = window.chatTestInstance;
            if (!chatTest) {
                alert('ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const userSearchMessage = "ë§ˆì¼€íŒ…íŒ€ ê¹€ì² ìˆ˜ë‹˜ ì •ë³´ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”";
            document.getElementById('chatInput').value = userSearchMessage;
            
            const event = new Event('submit');
            document.getElementById('chatForm').dispatchEvent(event);
        }

        function testDocuments() {
            const chatTest = window.chatTestInstance;
            if (!chatTest) {
                alert('ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const documentsMessage = "LGì „ì ì‹ ì œí’ˆ ì¶œì‹œ ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”";
            document.getElementById('chatInput').value = documentsMessage;
            
            const event = new Event('submit');
            document.getElementById('chatForm').dispatchEvent(event);
        }

        function testActionButton() {
            const chatTest = window.chatTestInstance;
            if (!chatTest) {
                alert('ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const actionButtonMessage = "íšŒì˜ ì¼ì •ì„ ì¡ì•„ì£¼ì„¸ìš”";
            document.getElementById('chatInput').value = actionButtonMessage;
            
            const event = new Event('submit');
            document.getElementById('chatForm').dispatchEvent(event);
        }

        function testMailToEvent() {
            const chatTest = window.chatTestInstance;
            if (!chatTest) {
                alert('ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const mailToEventMessage = "ì´ë©”ì¼ì—ì„œ íšŒì˜ ì¼ì •ì„ ì¶”ì¶œí•´ì„œ ìº˜ë¦°ë”ì— ë“±ë¡í•´ì£¼ì„¸ìš”";
            document.getElementById('chatInput').value = mailToEventMessage;
            
            const event = new Event('submit');
            document.getElementById('chatForm').dispatchEvent(event);
        }

        function newSession() {
            const chatTest = window.chatTestInstance;
            if (!chatTest) {
                alert('ì±„íŒ… ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ê¸°ì¡´ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì¢…ë£Œ
            if (chatTest.logStreamConnection) {
                chatTest.logStreamConnection.abort();
                chatTest.logStreamConnection = null;
            }
            
            // ìƒˆë¡œìš´ ì„¸ì…˜ ID ìƒì„± (UUID ì‚¬ìš©)
            chatTest.currentSessionId = null; // í˜„ì¬ ì„¸ì…˜ ID ì´ˆê¸°í™”
            const newSessionId = Utils.generateUUID();
            chatTest.currentSessionId = newSessionId;
            chatTest.sessionId.value = newSessionId; // ì…ë ¥ í•„ë“œì—ë„ ì„¤ì •
            
            // ì±„íŒ… ë©”ì‹œì§€ ì´ˆê¸°í™”
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ğŸ‰<br>
                        ì§ˆë¬¸ì„ ì…ë ¥í•´ë³´ì„¸ìš”!
                    </div>
                </div>
            `;
            
            // ë¡œê·¸ ì´ˆê¸°í™”
            chatTest.clearLog();
            chatTest.addLogEntry(`ğŸ†” ìƒˆ ëŒ€í™” ì‹œì‘: ${newSessionId}`, 'info');
            
            // ìƒˆë¡œìš´ ì„¸ì…˜ì— ëŒ€í•œ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼ ì¬ì—°ê²°
            setTimeout(() => {
                chatTest.startLogStreaming();
            }, 1000);
        }

        function toggleLog() {
            const logContent = document.getElementById('logContent');
            const toggleBtn = document.getElementById('logToggleBtn');
            const executionLog = document.querySelector('.execution-log');
            const chatContainer = document.querySelector('.chat-container');
            const resizer = document.getElementById('verticalResizer');
            
            if (executionLog.classList.contains('collapsed')) {
                // ë¡œê·¸ í¼ì¹˜ê¸°
                executionLog.classList.remove('collapsed');
                chatContainer.classList.remove('full-width');
                toggleBtn.textContent = 'ì ‘ê¸°';
                if (resizer) resizer.style.display = '';
                const chatTest = window.chatTestInstance;
                if (chatTest && typeof chatTest.getSavedSplit === 'function' && typeof chatTest.applySplit === 'function') {
                    const p = chatTest.getSavedSplit() ?? 72;
                    chatTest.applySplit(p);
                }
            } else {
                // ë¡œê·¸ ì ‘ê¸°
                executionLog.classList.add('collapsed');
                chatContainer.classList.add('full-width');
                toggleBtn.textContent = 'í¼ì¹˜ê¸°';
                // Clear inline sizing so chat can truly fill
                chatContainer.style.flex = '';
                executionLog.style.flex = '';
                if (resizer) resizer.style.display = 'none';
            }
        }

        function toggleConfig() {
            const configContent = document.getElementById('configContent');
            const configToggle = document.getElementById('configToggle');
            
            if (configContent.classList.contains('collapsed')) {
                configContent.classList.remove('collapsed');
                configToggle.textContent = 'â–¼';
            } else {
                configContent.classList.add('collapsed');
                configToggle.textContent = 'â–¶';
            }
        }

        function scrollToBottom() {
            // ìë™ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
            // const chatTest = window.chatTestInstance;
            // if (chatTest && chatTest.logContent) {
            //     chatTest.logContent.scrollTo({
            //         top: chatTest.logContent.scrollHeight,
            //         behavior: 'smooth'
            //     });
            // }
        }

        // ===== INITIALIZATION =====

        document.addEventListener('DOMContentLoaded', () => {
            window.chatTestInstance = new ChatTest();
        });
    </script>
</body>
</html>
